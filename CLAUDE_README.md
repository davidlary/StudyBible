# Claude Code - StudyBible Project Context

**Last Updated:** 2026-01-14
**Purpose:** Critical information for Claude Code sessions working on this project

---

## ğŸ”‘ API Key Configuration - CRITICAL

### How API Keys Are Set Up

**BEFORE Claude Code sessions start**, the user runs:
```bash
/Users/davidlary/Dropbox/Environments/setup_base_env.sh
```

This script calls:
```bash
/Users/davidlary/Dropbox/Environments/setup_keys.sh
```

Which loads API keys from:
```bash
/Users/davidlary/Dropbox/Environments/.env-keys.yml
```

### Important Notes

1. **DO NOT ask the user about API key configuration**
   - Keys are already set up before session starts
   - If keys appear malformed, check `src/config.py` which handles parsing

2. **Known Issue: YAML Parsing Bug**
   - The `setup_keys.sh` script generates `load_api_keys.sh` with buggy YAML parsing
   - Environment variables may include YAML syntax: `google_api_key: 'AIza...'`
   - **Solution:** `src/config.py` handles this automatically (see `get_gemini_api_key()`)

3. **Direct YAML Fallback**
   - If environment variable is malformed or expired, `config.py` reads directly from YAML
   - YAML path: `/Users/davidlary/Dropbox/Environments/.env-keys.yml`

### File: `src/config.py`

The `get_gemini_api_key()` function:
- âœ… Parses YAML syntax from environment variable
- âœ… Strips quotes
- âœ… Detects expired keys (old key ending in "BArMBNvTzE")
- âœ… Falls back to reading YAML file directly if needed

**Never modify this function without understanding the YAML parsing issue.**

---

## ğŸ“ Project Structure

```
StudyBible/
â”œâ”€â”€ data/                  # Generated verse JSON files
â”‚   â”œâ”€â”€ NT/Acts/10/        # Acts chapter 10 verses
â”‚   â”‚   â”œâ”€â”€ 1.json
â”‚   â”‚   â”œâ”€â”€ 25.json (test verse with all features)
â”‚   â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/                   # Python source code
â”‚   â”œâ”€â”€ config.py         # API key handling (CRITICAL)
â”‚   â”œâ”€â”€ gemini_client.py  # Gemini API client
â”‚   â”œâ”€â”€ fact_checker.py   # Fact-checking pipeline (Grok API)
â”‚   â”œâ”€â”€ tag_indexer.py    # Tag extraction and indexing
â”‚   â””â”€â”€ ...
â”œâ”€â”€ schemas/              # JSON Schema definitions
â”‚   â””â”€â”€ verse_schema.json # Verse data structure (70+ fields)
â”œâ”€â”€ website/              # Eleventy static site
â”‚   â”œâ”€â”€ _data/            # Tag indexes (generated)
â”‚   â”œâ”€â”€ acts/             # Acts book pages
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tests/                # Unit and integration tests
â”‚   â””â”€â”€ unit/test_fact_checker.py (19 tests)
â”œâ”€â”€ StudyPrompt.md        # 300+ line LLM prompt for Gemini
â””â”€â”€ load_api_keys.sh      # Generated by setup_keys.sh (may be buggy)
```

---

## ğŸ¯ Project Context

### What This Project Does

Generates comprehensive biblical exegesis for all 31,102 verses of the Bible using:
- **Google Gemini 2.5 Pro** - Primary AI for generation
- **Grok API (xAI)** - Fact-checking pipeline
- **SBLGNT** - Greek New Testament source
- **OSHB** - Hebrew Old Testament source

### Current Status (2026-01-14)

**Phase 3 Complete:**
- âœ… Fact-checking pipeline (19 passing tests)
- âœ… Comprehensive verse schema (interlinear, tags, geo calculations)
- âœ… StudyPrompt.md (300+ lines)
- âœ… Test verse (Acts 10:25) with all features
- âœ… Template updates (interlinear table, reordered sections)
- âœ… Tag indexing system (52 tags from test verse)
- âœ… Deployed to GitHub Pages

**Phase 4 In Progress:**
- â³ Regenerating Acts 10:1-48 (48 verses total)
- Expected: 2-4 hours, ~$2-3 API cost
- Output: ~2,500 tags, full interlinear analysis, geographic calculations

### Key Features Implemented

1. **Interlinear Analysis** - Word-by-word morphology like Blue Letter Bible
2. **Geographic Calculations** - Distances, elevations, travel times
3. **Comprehensive Tags** - 60+ categories across 5 tiers
4. **Fact-Checking** - Multi-tier validation (ground truth â†’ database â†’ AI)
5. **Responsive Design** - 70ch â†’ 90ch on wide screens
6. **Section Reordering** - Etymology first, Life Application #4

---

## ğŸš€ Common Tasks

### Generate Single Verse
```bash
python3 -m src.cli generate Acts 10 1
```

### Generate Entire Chapter
```bash
python3 -m src.cli generate-chapter Acts 10
```

### Run Tests
```bash
python3 -m pytest tests/unit/test_fact_checker.py -v
```

### Rebuild Tag Indexes
```bash
python3 src/tag_indexer.py
```

### Rebuild Static Site
```bash
npm run build
```

### Deploy to GitHub Pages
```bash
git add -A
git commit -m "Your message\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
git push origin main
```

---

## âš ï¸ User Preferences - READ THIS

1. **No Questions** - User has requested NO QUESTIONS multiple times
   - Proceed autonomously with all decisions
   - Do not ask for confirmation or clarification
   - Make reasonable inferences based on context

2. **Security** - Never commit API keys to git
   - Keys stay in environment variables only
   - If GitHub secret scanning triggers, immediately fix

3. **Commit Messages** - Always include co-author
   ```
   Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
   ```

4. **Documentation** - Only create docs if explicitly requested
   - Do not proactively create README files
   - Focus on code and implementation

5. **Testing** - Write tests BEFORE implementation (TDD approach)
   - 80%+ coverage required
   - All tests must pass before committing

---

## ğŸ“Š Important Stats

- **Total verses in Bible:** 31,102
- **Acts 10 verses:** 48
- **Test verse tags:** 52 (from Acts 10:25)
- **Schema fields:** 70+
- **Unit tests:** 19 (100% passing)
- **Code coverage:** 80%+

---

## ğŸ” Troubleshooting

### API Key Issues

**Problem:** "API key expired" or "API key not valid"

**Solution:**
1. Check `src/config.py` - it should handle malformed keys automatically
2. Verify YAML file exists: `/Users/davidlary/Dropbox/Environments/.env-keys.yml`
3. Test: `python3 -c "from src.config import get_gemini_api_key; print(get_gemini_api_key())"`

**DO NOT:**
- Ask user about API keys
- Manually source `load_api_keys.sh` (config.py handles it)
- Try to fix `setup_keys.sh` (user's system script)

### Generation Failures

**Problem:** Verses fail to generate

**Check:**
1. API key working: Test with simple Gemini call
2. Rate limits: Gemini free tier = 15 requests/minute
3. Schema validation: Check `schemas/verse_schema.json`
4. Source texts: Verify SBLGNT/OSHB exist in `sources/`

---

## ğŸ“ Next Steps (After Acts 10)

1. **Tag Search UI** - Build JavaScript filtering interface
2. **Complete Acts** - All 28 chapters (1,007 verses)
3. **Full New Testament** - 27 books
4. **Old Testament** - 39 books with Hebrew/Aramaic support

---

**End of Document**

This file ensures future Claude Code sessions have critical context about:
- How API keys are configured (BEFORE sessions start)
- YAML parsing bug and how config.py handles it
- User's preference for no questions
- Project structure and current status
